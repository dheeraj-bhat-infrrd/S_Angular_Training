var widgetFramework = '<div id="ss-widget-container" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 widget-pad-zero">' + '<div id="ss-widget-dash" class="hide" ></div>' + '<div id="ss-widget-options" class="col-lg-5 col-md-5 col-sm-6 col-xs-12 widget-left-pad-zero widget-right-pad-zero ss-widget-options-container">' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rating-btn-cont">' + '<div class="col-lg-5 col-md-5 col-sm-5 col-xs-5">' + '<div id="ss-widget-rating" class="ss-widget-rating ss-widget-font">0</div>' + '<div id="ss-widget-rating-stars" class="ss-widget-rating-stars">' + '<div class="ss-widget-star-box">' + '<div class="ss-widget-star1 ss-widget-star-container ss-widget-main-rat-cont"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-star2 ss-widget-star-container ss-widget-main-rat-cont"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-star3 ss-widget-star-container ss-widget-main-rat-cont"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-star4 ss-widget-star-container ss-widget-main-rat-cont"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-star5 ss-widget-star-container ss-widget-main-rat-cont"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '</div>' + '</div>' + '<div id="ss-widget-rev-count" class="ss-widget-rev-count">0 Reviews</div>' + '</div>' + '<div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">' + '<div id="widget-contact-us-btn" class="widget-btns widget-contact-us-btn ss-widget-font" data-link="">CONTACT US</div>' + '<div id="widget-write-rev-btn" class="widget-btns ss-widget-font" data-link="">WRITE A REVIEW</div>' + '</div>' + '</div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 widget-pad-zero ss-widget-rating-detils-container">' + '<div id="ss-widget-rating-details" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rating-details ss-widget-font">' + 'Rating Details <span class="float-right" style="font-size:  13px;">&#9662;</span>' + '</div>' + '<div id="ss-widget-rating-cont" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rating-cont">' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-star-cont">' + '<div class="col-lg-3 col-md-3 col-sm-3 col-xs-3 widget-pad-zero ss-widget-stars widget-star-blue">&#9733; &#9733; &#9733; &#9733; &#9733; </div>' + '<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 widget-pad-zero">' + '<div id="ss-widget-5star-bar" class="ss-widget-rating-bar widget-blue-bar"></div>' + '</div>' + '<div id="ss-widget-5star-perc" class="col-lg-1 col-md-1 col-sm-1 col-xs-1 ss-widget-rating-perc ss-widget-font">0%</div>' + '</div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-star-cont">' + '<div class="col-lg-3 col-md-3 col-sm-3 col-xs-3 widget-pad-zero ss-widget-stars widget-star-green">&#9733; &#9733; &#9733; &#9733; </div>' + '<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 widget-pad-zero">' + '<div id="ss-widget-4star-bar" class="ss-widget-rating-bar widget-green-bar"></div>' + '</div>' + '<div id="ss-widget-4star-perc" class="col-lg-1 col-md-1 col-sm-1 col-xs-1 ss-widget-rating-perc ss-widget-font">0%</div>' + '</div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-star-cont">' + '<div class="col-lg-3 col-md-3 col-sm-3 col-xs-3 widget-pad-zero ss-widget-stars widget-star-yellow">&#9733; &#9733; &#9733; </div>' + '<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 widget-pad-zero">' + '<div id="ss-widget-3star-bar" class="ss-widget-rating-bar widget-yellow-bar"></div>' + '</div>' + '<div id="ss-widget-3star-perc" class="col-lg-1 col-md-1 col-sm-1 col-xs-1 ss-widget-rating-perc ss-widget-font">0%</div>' + '</div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-star-cont">' + '<div class="col-lg-3 col-md-3 col-sm-3 col-xs-3 widget-pad-zero ss-widget-stars widget-star-orange">&#9733; &#9733; </div>' + '<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 widget-pad-zero">' + '<div id="ss-widget-2star-bar" class="ss-widget-rating-bar widget-orange-bar"></div>' + '</div>' + '<div id="ss-widget-2star-perc" class="col-lg-1 col-md-1 col-sm-1 col-xs-1 ss-widget-rating-perc ss-widget-font">0%</div>' + '</div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-star-cont">' + '<div class="col-lg-3 col-md-3 col-sm-3 col-xs-3 widget-pad-zero ss-widget-stars widget-star-red">&#9733; </div>' + '<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 widget-pad-zero">' + '<div id="ss-widget-1star-bar" class="ss-widget-rating-bar widget-red-bar"></div>' + '</div>' + '<div id="ss-widget-1star-perc" class="col-lg-1 col-md-1 col-sm-1 col-xs-1 ss-widget-rating-perc ss-widget-font">0%</div>' + '</div>' + '</div>' + '</div>' + '<div id="ss-widget-opt" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-opt-cont">' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-opt-text ss-widget-font">Options<span id="ss-widget-options-arrow" class="float-right cursor-pointer hide" style="font-size:  13px;">&#9662;</span></div>' + '<div id="ss-widget-options-dropdown" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-options-dropdown">' + '<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 ss-widget-opt">' + '<div class="w-100 ss-widget-opt-head-text ss-widget-font">Filter Source</div>' + '<div>' + '<input type="checkbox" id="widget-opt-all" name="filterSource" value="all" checked />' + '<label for="scales" class="ss-widget-font">All</label>' + '</div>' + '<div>' + '<input type="checkbox" id="widget-opt-ss" name="filterSource" value="ss" checked />' + '<label for="scales" class="ss-widget-font">SocialSurvey</label>' + '</div>' + '<div>' + '<input type="checkbox" id="widget-opt-ssv" name="filterSource" value="ssv" checked />' + '<label for="scales" class="ss-widget-font">SocialSurvey Verified</label>' + '</div>'
/*
 * + '<div>' + '<input type="checkbox" id="widget-opt-goo" name="filterSource" value="google" checked />' + '<label for="scales" class="ss-widget-font">Google</label>' + '</div>'
 */
+ '<div>' + '<input type="checkbox" id="widget-opt-zil" name="filterSource" value="zillow" checked />' + '<label for="scales" class="ss-widget-font">Zillow</label>' + '</div>'
/*
 * + '<div>' + '<input type="checkbox" id="widget-opt-fb" name="filterSource" value="fb" checked />' + '<label for="scales" class="ss-widget-font">Facebook</label>' + '</div>' + '<div>' + '<input type="checkbox" id="widget-opt-lin" name="filterSource" value="linkedin" checked />' + '<label for="scales">LinkedIn</label>' + '</div>'
 */
+ '</div>' + '<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 ss-widget-order-cont">' + '<div id="ss-widget-order-data" class="w-100 ss-widget-opt-head-text ss-widget-font" data-order="">Order By</div>' + '<div id="ss-widget-newest" class="w-100 ss-widget-order-text  ss-widget-font" data-order=1>Newest First</div>' + '<div id="ss-widget-oldest" class="w-100 ss-widget-order-text  ss-widget-font" data-order=2>Oldest First</div>' + '<div id="ss-widget-highest" class="w-100 ss-widget-order-text  ss-widget-font" data-order=3>Highest Rating</div>' + '<div id="ss-widget-lowest" class="w-100 ss-widget-order-text  ss-widget-font" data-order=4>Lowest Rating</div>' + '</div>' + '</div>' + '</div>' + '</div>' + '<div id="ss-widget-reviews" class="col-lg-7 col-md-7 col-sm-6 col-xs-12 ss-widget-rev-cont">' + '<div class="w-100 ss-widget-rev-head ss-widget-font">Reviews <span id="ss-widget-rev-options" class="float-right cursor-pointer ss-widget-font">Options &#9662;</span></div><div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-review-div-container">' + '<div id="ss-widget-review-div" class="w-100" data-allReviews=[] data-zillow=[] data-initialRev=1 data-maxLoadRev=1 data-startIndex=0 data-batchSize=1 data-index=0 data-nextBatchIndex=0 data-widgetDetails></div>' + '</div><div id="ss-widget-load-more-cont" class="col-lg-12 col-md-12 col-sm-12 col-xs-12">' + '<div id="ss-widget-load-more-btn" class="ss-widget-load-more-btn ss-widget-font">Load More</div>' + '</div>' + '<div id="ss-widget-modest-branding" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-powered-by ss-widget-font hide">' + 'Powered by <span class="ss-widget-text-bold ss-widget-font">SocialSurvey</span>' + '</div>' + '</div>' + '</div>';

var widgetReviewTemplate = '<div id="ss-widget-review-container" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev hide" data-index=0>' + '<div class="w-100">' + '<div class="float-left ss-widget-rev-date ss-widget-rev-font"></div>' + '<div class="float-right ss-widget-prov-by ss-widget-pow-by ss-widget-rev-font">provided by <div class="ss-widget-verified-badge ss-wi-verified-badge  ss-wi-verify-image ss-wi-zillow-badge  ss-wi-verify-image-zillow ss-wi-unverified-badge  ss-wi-verify-image-ss float-right" ></div></div>' + '</div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev-details">' + '<div class="ss-widget-prof-pic-cont"><img src="/resources/images/image_pt.png" class="ss-widget-prof-pic"></div>' + '<div class="ss-widget-rev-prof-details">' + '<div class="ss-widget-prov-by  ss-widget-rev-font">In reference to a transaction with</div>' + '<div class="ss-widget-rev-prof-name ss-widget-rev-font"></div>' + '<div class="ss-widget-rev-prof-title ss-widget-rev-font"> | NMLS# </div>' + '</div>' + '</div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev-stars">' + '<div class="ss-widget-star1 ss-widget-star-container"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-star2 ss-widget-star-container"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-star3 ss-widget-star-container"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-star4 ss-widget-star-container"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-star5 ss-widget-star-container"><div class="widget-black-star hide">&#9733;</div><div class="widget-white-star">&#9734;</div></div>' + '<div class="ss-widget-rev-score  ss-widget-rev-font">0.0</div>' + '</div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev-cust-name  ss-widget-rev-font">Stacey M <span class="ss-widget-rev-cust-addr  ss-widget-rev-font">- Los Angeles, CA</span></div>' + '<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev-text-cont">' + '<div class="ss-widget-rev-text-quote">&#10075;</div>' + '<div class="ss-widget-rev-text-quote">&#10075;</div>' + '<div class="ss-widget-rev-text">' + '<p class="ss-widget-review-text ss-widget-rev-font">Sample</p>' + '<p class="ss-widget-text-bold ss-widget-read-more cursor-pointer ss-widget-rev-font">... read more</p>' + '</div>' + '</div>' + '</div>';


function drawWidgetFramework($, widgetOuterContainer, widgetDetails, profileName, profileLevel, companyProfileName, resourcesHost, ssHost) {
	widgetOuterContainer.html(widgetFramework);
	if (widgetOuterContainer.width() < 768) {
		$('#ss-widget-options').css('width', '100%');
		$('#ss-widget-reviews').css('width', '100%');
		$('#ss-widget-options-arrow').removeClass('hide');
		$('#ss-widget-rev-options').addClass('hide');
	} else if (widgetOuterContainer.width() < 1000) {
		$('#ss-widget-options').css('width', '50%');
		$('#ss-widget-reviews').css('width', '50%');
	}

	if (widgetOuterContainer.width() >= 768) {
		$('#ss-widget-rev-options').hide();
	}
	$('#ss-widget-container').attr('data-profileName', profileName);
	$('#ss-widget-container').attr('data-profileLevel', profileLevel);
	$('#ss-widget-container').attr('data-companyProfileName', companyProfileName);

	drawWidgetDataEntities($, widgetDetails);
	drawWidgetStyleElements($, widgetDetails);
	$('#ss-widget-review-div').data('widgetDetails', widgetDetails);
	drawWidgetReviews($, widgetDetails, profileName, profileLevel, companyProfileName, resourcesHost, ssHost);
	bindWidgetButtonActions($, widgetDetails, resourcesHost, ssHost);
	setupTags($, widgetDetails);
}

function drawWidgetStyleElements($, widgetDetails) {
	var bgColor = widgetDetails.widgetConfiguration.backgroundColor;
	var fontTheme = widgetDetails.widgetConfiguration.fontTheme;
	var font = widgetDetails.widgetConfiguration.font;
	$('#ss-widget-container').css('background', bgColor);
	$('.ss-widget-rev-count').css('color', fontTheme);
	$('#ss-widget-container').css('color', fontTheme);

	if (font != null && font != '' && font != undefined) {
		$('#ss-widget-container *').css('font-family', font);
		$('.ss-widget-font').css('font-family', font);
	}

	var foregroundColor = widgetDetails.widgetConfiguration.foregroundColor;
	var embeddedFontTheme = widgetDetails.widgetConfiguration.embeddedFontTheme;
	$('.ss-widget-rating-details').css('background', foregroundColor);
	$('#ss-widget-opt').css('background', foregroundColor);
	$('.ss-widget-rev-head').css('background', foregroundColor);
	$('#widget-contact-us-btn').css('background', foregroundColor);
	$('#widget-write-rev-btn').css('background', foregroundColor);
	$('#widget-contact-us-btn').css('opacity', widgetDetails.widgetConfiguration.buttonOneOpacity);
	$('#widget-write-rev-btn').css('opacity', widgetDetails.widgetConfiguration.buttonTwoOpacity);
	$('.widget-btns').css('color', embeddedFontTheme);
	$('.ss-widget-rating-details').css('color', embeddedFontTheme);
	$('.ss-widget-opt-cont').css('color', embeddedFontTheme);
	$('.ss-widget-rev-head').css('color', embeddedFontTheme);
	$('.ss-widget-load-more-btn').css('background', foregroundColor);
	$('.ss-widget-load-more-btn').css('opacity', widgetDetails.widgetConfiguration.reviewLoaderOpacity);
	$('.ss-widget-load-more-btn').html(widgetDetails.widgetConfiguration.reviewLoaderName);
	$('#widget-contact-us-btn').html(widgetDetails.widgetConfiguration.buttonOneName);
	$('#widget-write-rev-btn').html(widgetDetails.widgetConfiguration.buttonTwoName);
	$('.ss-widget-load-more-btn').css('color', embeddedFontTheme);
	
	var borderColorR = hexToRgb(foregroundColor).r;
	var borderColorG = hexToRgb(foregroundColor).g;
	var borderColorB = hexToRgb(foregroundColor).b;
	var borderOpacity = 0.8;
	var borderColor = 'rgba('+borderColorR+','+borderColorG+','+borderColorB+','+borderOpacity+')';
	$('.ss-widget-review-div-container').css('border-color',borderColor);
	
	var ratingAndStarColor = widgetDetails.widgetConfiguration.ratingAndStarColor;
	$('#ss-widget-rating').css('color', ratingAndStarColor);
	$('#ss-widget-rating-stars').css('color', ratingAndStarColor);

	var barGraphColor = widgetDetails.widgetConfiguration.barGraphColor;

	if (barGraphColor != '' && barGraphColor != null && barGraphColor != undefined) {
		$('.ss-widget-rating-cont').css('color', barGraphColor);
		$('.ss-widget-stars').css('color', barGraphColor);
		$('.ss-widget-rating-bar').css('background', barGraphColor);
	}
}

function hexToRgb(hex) {
    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}


function drawWidgetDataEntities($, widgetDetails) {
	var averageRating = widgetDetails.averageRating;
	$('#ss-widget-rating').html(averageRating);
	drawWidgetRatingStars($, $('#ss-widget-rating-stars'), averageRating);

	var hideOptions = widgetDetails.widgetConfiguration.hideOptions;
	var hideBarGraph = widgetDetails.widgetConfiguration.hideBarGraph;

	var widgetOuterContainer = $('#ss-widget-container').parent();
	if (hideOptions != null && hideOptions != undefined) {
		if (hideOptions == "true" || hideOptions == true) {
			if (widgetOuterContainer.width() < 768) {
				$('#ss-widget-opt').addClass('hide');
				$('#ss-widget-options-arrow').addClass('hide');
				$('#ss-widget-rev-options').removeClass('hide');
			} else {
				$('#ss-widget-options-dropdown').addClass('hide');
				$('#ss-widget-options-arrow').removeClass('hide');
			}
		}else{
			$('#ss-widget-options-arrow').removeClass('hide');
		}
	}

	if (hideBarGraph != null && hideBarGraph != undefined) {
		if (hideBarGraph == "true" || hideBarGraph == true) {
			$('#ss-widget-rating-cont').addClass('hide');
		}
	}

	var contactLink = widgetDetails.widgetConfiguration.buttonOneLink;
	var writeRevLink = widgetDetails.widgetConfiguration.buttonTwoLink;
	
	contactLink = contactLink.match(/^https?:/) ? contactLink : '//' + contactLink;
	writeRevLink = writeRevLink.match(/^https?:/) ? writeRevLink : '//' + contactLink;
	$('#widget-contact-us-btn').attr('data-link', contactLink);
	$('#widget-write-rev-btn').attr('data-link', writeRevLink);

	var twoStar = widgetDetails.twoStar;
	var threeStar = widgetDetails.threeStar;
	var oneStar = widgetDetails.oneStar;
	var fourStar = widgetDetails.fourStar;
	var fiveStar = widgetDetails.fiveStar;
	var total = oneStar + twoStar + threeStar + fourStar + fiveStar;
	var greatestNumber = isGreatestNumber([ oneStar, twoStar, threeStar, fourStar, fiveStar ]);
	$('#ss-widget-rev-count').html(total + ' Reviews');

	if(greatestNumber != 0 && !isNaN(greatestNumber) && greatestNumber != undefined){
		$('#ss-widget-5star-bar').css('width', (100 * fiveStar / greatestNumber) + '%');
		$('#ss-widget-4star-bar').css('width', (100 * fourStar / greatestNumber) + '%');
		$('#ss-widget-3star-bar').css('width', (100 * threeStar / greatestNumber) + '%');
		$('#ss-widget-2star-bar').css('width', (100 * twoStar / greatestNumber) + '%');
		$('#ss-widget-1star-bar').css('width', (100 * oneStar / greatestNumber) + '%');
	}

	if(total != 0 && !isNaN(total) && total != undefined){
		$('#ss-widget-5star-perc').html((Math.round(100 * fiveStar / total)) + '%');
		$('#ss-widget-4star-perc').html(Math.round((100 * fourStar / total)) + '%');
		$('#ss-widget-3star-perc').html(Math.round((100 * threeStar / total)) + '%');
		$('#ss-widget-2star-perc').html(Math.round((100 * twoStar / total)) + '%');
		$('#ss-widget-1star-perc').html(Math.round((100 * oneStar / total)) + '%');
	}
	
	var initialNumberOfReviews = widgetDetails.widgetConfiguration.initialNumberOfReviews;
	var maxReviewsOnLoadMore = widgetDetails.widgetConfiguration.maxReviewsOnLoadMore;
	var reviewSources = widgetDetails.widgetConfiguration.reviewSources;

	$('#ss-widget-review-div').attr('data-initalRev', initialNumberOfReviews);
	$('#ss-widget-review-div').attr('data-maxLoadRev', maxReviewsOnLoadMore);
	drawReviewSourcesSelection($, reviewSources);

	var allowModestBranding = widgetDetails.widgetConfiguration.allowModestBranding;
	if (allowModestBranding == true || allowModestBranding == 'true') {
		$('#ss-widget-modest-branding').removeClass('hide');
	}

	var reviewSortOrder = widgetDetails.widgetConfiguration.reviewSortOrder;
	drawSortOrder($, reviewSortOrder);
}

function drawSortOrder($, reviewSortOrder) {
	if (reviewSortOrder == 'highestRatingFirst') {
		$('#ss-widget-highest').addClass('ss-widget-order-text-active');
	} else if (reviewSortOrder == 'lowestRatingFirst') {
		$('#ss-widget-lowest').addClass('ss-widget-order-text-active');
	} else if (reviewSortOrder == 'newestFirst') {
		$('#ss-widget-newest').addClass('ss-widget-order-text-active');
	} else if (reviewSortOrder == 'oldestFirst') {
		$('#ss-widget-oldest').addClass('ss-widget-order-text-active');
	}
	$('#ss-widget-order-data').attr('data-order', reviewSortOrder);
}

function drawReviewSourcesSelection($, reviewSources) {

	if (reviewSources == null || reviewSources == undefined || reviewSources == "" || reviewSources.length == 0) {
		$('#widget-opt-ss').prop("checked", true);
		$('#widget-opt-ssv').prop("checked", true)
		$('#widget-opt-zil').prop("checked", true);
		$('#widget-opt-all').prop("checked", true);
		return;
	}else {
		$('#widget-opt-ss').prop("checked", false);
		$('#widget-opt-ssv').prop("checked", false)
		$('#widget-opt-zil').prop("checked", false);
		$('#widget-opt-all').prop("checked", false);
	}
	
	if( reviewSources.indexOf('SocialSurvey') >= 0 ){
		$('#widget-opt-ss').prop("checked", true);
	}
	
	if( reviewSources.indexOf('SocialSurvey Verified') >= 0 ){
		$('#widget-opt-ssv').prop("checked", true);
	}

	if( reviewSources.indexOf('Zillow') >= 0 ){
		$('#widget-opt-zil').prop("checked", true);
	}

	if ($('#widget-opt-ss').prop("checked") && $('#widget-opt-ssv').prop("checked") && $('#widget-opt-zil').prop("checked")) {
		$('#widget-opt-all').prop("checked", true);
	} else {
		$('#widget-opt-all').prop("checked", false);
	}

}


function drawWidgetReviews($, widgetDetails, profileName, profileLevel, companyProfileName, resourcesHost, ssHost) {
	var startIndex = 0;
	var batchSize = 20;
	var reviewSortOrder = widgetDetails.widgetConfiguration.reviewSortOrder;
	var reviewSources = widgetDetails.widgetConfiguration.reviewSources;

	if (!$('#widget-opt-ss').prop("checked") && !$('#widget-opt-ssv').prop("checked") && !$('#widget-opt-zil').prop("checked") && !$('#widget-opt-all').prop("checked", !$('#widget-opt-all').prop("checked"))) {
		var reviewDiv = '<div id="ss-widget-review-no-source-selected" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev" style="text-align: center;">No review Source Selected</div>';
		$('#ss-widget-review-div').html(reviewDiv);
		return;
	} else {
		$('#ss-widget-review-no-source-selected').remove();
	}

	$('#ss-widget-review-div').html('');

	var payload = {
		"startScore" : -1,
		"limitScore" : -1,
		"startIndex" : startIndex,
		"numOfRows" : batchSize,
		"profileLevel" : profileLevel,
		"companyProfileName" : companyProfileName,
		"profileName" : profileName,
		"fetchAbusive" : false,
		"startDate" : "",
		"endDate" : "",
		"sortCriteria" : reviewSortOrder,
		"surveySources" : reviewSources
	};

	callAjaxGetWithPayloadJsonpData($, ssHost +'/rest/widget/getreviews', function(data) {
		paintWidgetReviews($, data, resourcesHost, ssHost);
		paintWidgetReviewStyles($, widgetDetails);

		var initialNumberOfReviews = parseInt($('#ss-widget-review-div').attr('data-initalRev'));

	}, function() {
	}, payload, true);
}

function paintWidgetReviews($, reviews, resourcesHost, ssHost) {

	if (reviews.length == 0 || reviews == null || reviews == undefined) {
		var reviewDiv = '<div id="ss-widget-no-reviews" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev" style="text-align: center;">No reviews found</div>';
		$('#ss-widget-review-div').html(reviewDiv);
		return;
	}

	var initialNumberOfReviews = parseInt($('#ss-widget-review-div').attr('data-initalRev'));

	for (var i = 0; i < reviews.length; i++) {
		$('#ss-widget-review-div').append(widgetReviewTemplate);
		var reviewSource = reviews[i].source;
		var profileImageUrl = reviews[i].agentProfileImage;
		var profName = reviews[i].agentName;
		var title = reviews[i].agentTitle;
		var rating = reviews[i].score;
		var customerName = '';
		
		if(reviews[i].customerFirstName != null && reviews[i].customerFirstName != undefined && reviews[i].customerFirstName != ''){
			
			var firstNameSplits = reviews[i].customerFirstName.split(" ");
			
			customerName += firstNameSplits[0] + ' ';
			
			var lastName = '';
			if(firstNameSplits.length < 2){
				if(reviews[i].customerLastName != null && reviews[i].customerLastName != undefined && reviews[i].customerLastName != ''){
					lastName = reviews[i].customerLastName.split("")[0];
				}
			}else{
				lastName = firstNameSplits[1].split("")[0];
			}
			customerName += lastName;
			
		}else if(reviews[i].customerLastName != null && reviews[i].customerLastName != undefined && reviews[i].customerLastName != ''){
			
			var lastNameSplits = reviews[i].customerLastName.split(" ");
			
			customerName += lastNameSplits[0] + ' ';
			
			var lastName = '';
			if(lastNameSplits.length > 1){
				lastName = lastNameSplits[1].split("")[0];
			}
			customerName += lastName;
		}
		
		if(customerName.split(" ")[0].length < 2){
			if(reviews[i].customerLastName != null && reviews[i].customerLastName != undefined && reviews[i].customerLastName != ''){
				customerName = customerName.split(" ")[0] + ' ' + reviews[i].customerLastName.split(" ")[0];
			}
		}
		
		var customerCity = reviews[i].city;
		var customerState = reviews[i].state;
		var review = reviews[i].review;

		var reviewDateTimeStamp;
		if(reviews[i].surveyCompletedDate != null && reviews[i].surveyCompletedDate != undefined && reviews[i].surveyCompletedDate != '' && parseInt(reviews[i].surveyCompletedDate) != 0){
			reviewDateTimeStamp = parseInt(reviews[i].surveyCompletedDate);
		}else if(reviews[i].surveyTransactionDate != null && reviews[i].surveyTransactionDate != undefined && reviews[i].surveyTransactionDate != '' && parseInt(reviews[i].surveyTransactionDate) != 0){
			reviewDateTimeStamp = parseInt(reviews[i].surveyTransactionDate);
		}else{
			reviewDateTimeStamp = parseInt(reviews[i].createdOn);
		}
		
		var reviewDate = new Date(reviewDateTimeStamp);
		var monthName = new Array("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December");
		var reviewDateStr = monthName[reviewDate.getMonth()] + ' ' + (reviewDate.getDate() % 10 != reviewDate.getDate() ? reviewDate.getDate() : ('0' + reviewDate.getDate())) + ', ' + reviewDate.getFullYear();
		$('#ss-widget-review-container').find('.ss-widget-rev-date').html(reviewDateStr);
		drawWidgetVerifiedBadge($, reviewSource);

		if(profileImageUrl == null|| profileImageUrl == undefined || profileImageUrl == ''){

			profileImageUrl = resourcesHost +'/widget/images/person.png';
			
			$('#ss-widget-review-container').find('.ss-widget-prof-pic').addClass('ss-widget-default-dp');
		}
		$('#ss-widget-review-container').find('.ss-widget-prof-pic').attr('src', profileImageUrl);
		
		$('#ss-widget-review-container').find('.ss-widget-rev-prof-name').html(profName);
		$('#ss-widget-review-container').find('.ss-widget-rev-prof-title').html(title);
		drawWidgetRatingStars($, $('#ss-widget-review-container').find('.ss-widget-rev-stars'), rating)
		$('#ss-widget-review-container').find('.ss-widget-rev-score').html(rating.toPrecision(2));
		$('#ss-widget-review-container').find('.ss-widget-rev-cust-name').html(customerName);
		$('#ss-widget-review-container').find('.ss-widget-rev-cust-addr').html(' -' + customerCity + ', ' + customerState);
		$('#ss-widget-review-container').find('.ss-widget-review-text').html(review);

		if (reviewSource == 'Zillow') {
			$('#ss-widget-review-container').find('.ss-widget-rev-stars').addClass('ss-widget-zil-rev-star');
		}
		
		$('#ss-widget-review-container').removeClass('hide');
		if ($('#ss-widget-review-container').find('.ss-widget-review-text').height() <= $('#ss-widget-review-container').find('.ss-widget-rev-text').height() + 2) {
			$('#ss-widget-review-container').find('.ss-widget-read-more').hide();
		}
		$('#ss-widget-review-container').addClass('hide');

		if (i < initialNumberOfReviews) {
			$('#ss-widget-review-container').removeClass('hide');
			$('#ss-widget-review-div').attr('data-index', i);
		}

		$('#ss-widget-review-container').attr('data-index', i + 1);
		$('#ss-widget-review-container').attr('id', 'ss-widget-review-container-' + i);

	}
	$('#ss-widget-review-div').attr('data-nextBatchIndex', parseInt($('#ss-widget-review-div').attr('data-nextBatchIndex')) + reviews.length);
	
	var loadMoreFlag = false;
	$('#ss-widget-reviews').find('.ss-widget-rev').each(function(){
		if($(this).hasClass('hide')){
			loadMoreFlag =  true;
			return false;
		}
	});
	
	if(loadMoreFlag){
		$('#ss-widget-load-more-btn').show();
	}else{
		$('#ss-widget-load-more-btn').hide();
	}
}

function drawWidgetVerifiedBadge($, reviewSource) {

	if (reviewSource == 'encompass' || reviewSource == 'DOTLOOP' || reviewSource == 'API' || reviewSource == 'FTP' || reviewSource == 'LONEWOLF') {
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-zillow-badge');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-verify-image-zillow');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-unverified-badge');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-verify-image-ss');

	} else if (reviewSource == 'Zillow') {
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-verified-badge');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-verify-image');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-unverified-badge');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-verify-image-ss');
	} else {
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-verified-badge');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-verify-image');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-zillow-badge');
		$('#ss-widget-review-container').find('.ss-widget-verified-badge').removeClass('ss-wi-verify-image-zillow');
	}

}

function paintWidgetReviewStyles($, widgetDetails) {
	var bgColor = widgetDetails.widgetConfiguration.backgroundColor;
	var ratingAndStarColor = widgetDetails.widgetConfiguration.ratingAndStarColor;
	var fontTheme = widgetDetails.widgetConfiguration.fontTheme;

	$('.ss-widget-rev-prof-name').css('color', fontTheme);
	$('.ss-widget-read-more').css('background', bgColor);
	$('.ss-widget-read-more').css('color', fontTheme);
	$('.ss-widget-rev-cust-name').css('color', fontTheme);
	$('.ss-widget-rev-score').css('color', fontTheme);
	
	$('.ss-widget-rev-stars').css('color', ratingAndStarColor);
	$('.ss-widget-zil-rev-star').css('color', '#74c005');
	
	var font = widgetDetails.widgetConfiguration.font;
	if (font != null && font != '') {
		$('.ss-widget-rev-font').css('font-family', font);
	}
	
}

function isGreatestNumber(numbers) {

	var greatestNumber = numbers[0];
	for (var i = 1; i < numbers.length; i++) {
		if (numbers[i] > greatestNumber) {
			greatestNumber = numbers[i];
		}
	}
	return greatestNumber;
}


function initializeWidget($, widgetOuterContainer, profileName, profileLevel, companyProfileName, resourcesHost, ssHost ) {
	var payload = {
		"profileName" : profileName,
		"profileLevel" : profileLevel,
		"companyProfileName" : companyProfileName
	};


	var url =  ssHost +'/rest/widget/getwidgetdetails';

	showWidgetDashOverlay($, '#ss-widget-dash');

	callAjaxGetWithPayloadJsonpData($, url, function(data) {
		drawWidgetFramework($, widgetOuterContainer, data, profileName, profileLevel, companyProfileName, resourcesHost, ssHost);
	}, function() {
		hideWidgetDashOverlay($, '#ss-widget-dash');
	}, payload, true);
}

function drawWidgetRatingStars($, parent, averageRating) {

	if (Math.floor(averageRating) == averageRating) {
		switch (Math.floor(averageRating)) {
		case 1:
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			break;
		case 2:
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star2').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star2').find('.widget-white-star').addClass('hide');
			break;
		case 3:
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star2').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star2').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star3').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star3').find('.widget-white-star').addClass('hide');
			break;
		case 4:
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star2').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star2').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star3').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star3').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star4').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star4').find('.widget-white-star').addClass('hide');
			break;
		case 5:
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star2').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star2').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star3').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star3').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star4').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star4').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star5').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star5').find('.widget-white-star').addClass('hide');
			break;
		}
	} else {
		if (Math.floor(averageRating) < 1) {
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').removeClass('hide');

			if (averageRating > 0.55) {
				parent.find('.ss-widget-star1').find('.widget-white-star').addClass('ss-widget-3quat-white-star');
				parent.find('.ss-widget-star1').find('.widget-black-star').addClass('ss-widget-3quat-black-star');
			} else if (averageRating > 0.25) {
				parent.find('.ss-widget-star1').find('.widget-white-star').addClass('ss-widget-half-white-star');
				parent.find('.ss-widget-star1').find('.widget-black-star').addClass('ss-widget-half-black-star');
			} else {
				parent.find('.ss-widget-star1').find('.widget-white-star').addClass('ss-widget-quat-white-star');
				parent.find('.ss-widget-star1').find('.widget-black-star').addClass('ss-widget-quat-black-star');
			}
		} else if (Math.floor(averageRating) < 2) {
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star2').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star2').find('.widget-white-star').removeClass('hide');

			if (averageRating > 1.55) {
				parent.find('.ss-widget-star2').find('.widget-white-star').addClass('ss-widget-3quat-white-star');
				parent.find('.ss-widget-star2').find('.widget-black-star').addClass('ss-widget-3quat-black-star');
			} else if (averageRating > 1.25) {
				parent.find('.ss-widget-star2').find('.widget-white-star').addClass('ss-widget-half-white-star');
				parent.find('.ss-widget-star2').find('.widget-black-star').addClass('ss-widget-half-black-star');
			} else {
				parent.find('.ss-widget-star2').find('.widget-white-star').addClass('ss-widget-quat-white-star');
				parent.find('.ss-widget-star2').find('.widget-black-star').addClass('ss-widget-quat-black-star');
			}
		} else if (Math.floor(averageRating) < 3) {
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star2').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star2').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star3').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star3').find('.widget-white-star').removeClass('hide');

			if (averageRating > 2.55) {
				parent.find('.ss-widget-star3').find('.widget-white-star').addClass('ss-widget-3quat-white-star');
				parent.find('.ss-widget-star3').find('.widget-black-star').addClass('ss-widget-3quat-black-star');
			} else if (averageRating > 2.25) {
				parent.find('.ss-widget-star3').find('.widget-white-star').addClass('ss-widget-half-white-star');
				parent.find('.ss-widget-star3').find('.widget-black-star').addClass('ss-widget-half-black-star');
			} else {
				parent.find('.ss-widget-star3').find('.widget-white-star').addClass('ss-widget-quat-white-star');
				parent.find('.ss-widget-star3').find('.widget-black-star').addClass('ss-widget-quat-black-star');
			}
		} else if (Math.floor(averageRating) < 4) {
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star2').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star2').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star3').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star3').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star4').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star4').find('.widget-white-star').removeClass('hide');

			if (averageRating > 3.55) {
				parent.find('.ss-widget-star4').find('.widget-white-star').addClass('ss-widget-3quat-white-star');
				parent.find('.ss-widget-star4').find('.widget-black-star').addClass('ss-widget-3quat-black-star');
			} else if (averageRating > 3.25) {
				parent.find('.ss-widget-star4').find('.widget-white-star').addClass('ss-widget-half-white-star');
				parent.find('.ss-widget-star4').find('.widget-black-star').addClass('ss-widget-half-black-star');
			} else {
				parent.find('.ss-widget-star4').find('.widget-white-star').addClass('ss-widget-quat-white-star');
				parent.find('.ss-widget-star4').find('.widget-black-star').addClass('ss-widget-quat-black-star');
			}
		} else {
			parent.find('.ss-widget-star1').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star1').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star2').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star2').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star3').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star3').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star4').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star4').find('.widget-white-star').addClass('hide');
			parent.find('.ss-widget-star5').find('.widget-black-star').removeClass('hide');
			parent.find('.ss-widget-star5').find('.widget-white-star').removeClass('hide');

			if (averageRating > 4.55) {
				parent.find('.ss-widget-star5').find('.widget-white-star').addClass('ss-widget-3quat-white-star');
				parent.find('.ss-widget-star5').find('.widget-black-star').addClass('ss-widget-3quat-black-star');
			} else if (averageRating > 4.25) {
				parent.find('.ss-widget-star5').find('.widget-white-star').addClass('ss-widget-half-white-star');
				parent.find('.ss-widget-star5').find('.widget-black-star').addClass('ss-widget-half-black-star');
			} else {
				parent.find('.ss-widget-star5').find('.widget-white-star').addClass('ss-widget-quat-white-star');
				parent.find('.ss-widget-star5').find('.widget-black-star').addClass('ss-widget-quat-black-star');
			}
		}
	}

}

function bindWidgetButtonActions($, widgetDetails, resourcesHost, ssHost) {
	$(document).off('click', '#widget-contact-us-btn').on('click', '#widget-contact-us-btn', function(e) {
		var link = $(this).attr('data-link');
		/*if( link != undefined && link.indexOf('http') != 0 ){
			link = "//" + link;
		}*/
		window.open(link, '_blank');
	});

	$(document).off('click', '#widget-write-rev-btn').on('click', '#widget-write-rev-btn', function(e) {
		var link = $(this).attr('data-link');
		window.open(link, '_blank');
	});

	$(document).off('click', '#ss-widget-rating-details').on('click', '#ss-widget-rating-details', function(e) {
		e.stopImmediatePropagation();
		e.preventDefault();
		$('#ss-widget-rating-cont').slideToggle();
	});

	$(document).off('click', '#ss-widget-options-arrow').on('click', '#ss-widget-options-arrow', function(e) {
		e.stopImmediatePropagation();
		e.preventDefault();

		var widgetOuterContainer = $('#ss-widget-container').parent();
		if (widgetOuterContainer.width() < 768) {
			$('#ss-widget-opt').slideToggle();
			$('#ss-widget-options-arrow').toggle();
			$('#ss-widget-rev-options').toggle();
		} else {
			$('#ss-widget-options-dropdown').slideToggle();
		}
	});

	$(document).off('click', '#ss-widget-rev-options').on('click', '#ss-widget-rev-options', function(e) {
		e.stopImmediatePropagation();
		e.preventDefault();

		var widgetOuterContainer = $('#ss-widget-container').parent();
		if (widgetOuterContainer.width() < 768) {
			$('#ss-widget-opt').slideToggle();
			$('#ss-widget-options-arrow').toggle();
			$('#ss-widget-rev-options').toggle();
		}else{
			$('#ss-widget-opt').slideToggle();
		}
		
	});

	$(document).off('click', '#ss-widget-load-more-btn').on('click', '#ss-widget-load-more-btn', function(e) {
		e.stopImmediatePropagation();
		e.preventDefault();

		var nextIndex = parseInt($('#ss-widget-review-div').attr('data-index')) + 1;
		var maxLoadRev = parseInt($('#ss-widget-review-div').attr('data-maxLoadRev'));
		var initialRev = parseInt($('#ss-widget-review-div').attr('data-initialRev'));

		if ($('#ss-widget-review-container-' + nextIndex).length == 0) {
			getWidgetReviews($, resourcesHost, ssHost);
		} else {
			for (var i = 0; i < maxLoadRev; i++) {
				if ($('#ss-widget-review-container-' + (nextIndex + i)).length == 1) {
					$('#ss-widget-review-container-' + (nextIndex + i)).fadeIn();
					$('#ss-widget-review-container-' + (nextIndex + i)).removeClass('hide');
					$('#ss-widget-review-div').attr('data-index', (nextIndex + i));
				} else {
					getWidgetReviews($, resourcesHost, ssHost);
					break;
				}
			}
			var loadMoreFlag = false;
			$('#ss-widget-reviews').find('.ss-widget-rev').each(function(){
				if($(this).hasClass('hide')){
					loadMoreFlag =  true;
					return false;
				}
			});
			
			if(loadMoreFlag){
				$('#ss-widget-load-more-btn').show();
			}else{
				$('#ss-widget-load-more-btn').hide();
			}
		}
	});

	$('input[name=filterSource]').off('change').on('change', function(e) {
		e.stopImmediatePropagation();
		e.preventDefault();
		if( $(this).val() == "all" ){
			if( $(this).prop("checked") ){
				$('input[name=filterSource]').prop( "checked", true );
			}
		} else {
			if( !$(this).prop("checked") ){
				$('#widget-opt-all').prop("checked",false);
			}
		}
		updateWidgetReviews($, resourcesHost, ssHost );
	});

	$(document).off('click', '.ss-widget-order-text').on('click', '.ss-widget-order-text', function(e) {
		e.stopImmediatePropagation();
		e.preventDefault();

		if($(this).hasClass('ss-widget-order-text-active')){
			return;
		}
		
		$('.ss-widget-order-text-active').removeClass('ss-widget-order-text-active');
		$(this).addClass('ss-widget-order-text-active');

		switch (parseInt($(this).attr('data-order'))) {
		case 1:
			$('#ss-widget-order-data').attr('data-order', 'newestFirst');
			break;
		case 2:
			$('#ss-widget-order-data').attr('data-order', 'oldestFirst');
			break;
		case 3:
			$('#ss-widget-order-data').attr('data-order', 'highestRatingFirst');
			break;
		case 4:
			$('#ss-widget-order-data').attr('data-order', 'lowestRatingFirst');
			break;
		default:
			$('#ss-widget-order-data').attr('data-order', 'highestRatingFirst');
			break;
		}

		updateWidgetReviews($, resourcesHost, ssHost);
	});
	
	$(document).off('click','.ss-widget-read-more').on('click','.ss-widget-read-more',function(e){
		$(this).hide();
		$(this).parent().css('max-height','none');
		$(this).parent().css('overflow','none');
		$(this).closest('.ss-widget-rev').css('max-height','none');
	});
}


function getWidgetReviews($, resourcesHost, ssHost ) {
	var startIndex = parseInt($('#ss-widget-review-div').attr('data-nextBatchIndex'));
	var batchSize = 20;
	var reviewSortOrder = $('#ss-widget-order-data').attr('data-order');
	var reviewSources = getReviewSources($);
	var profileName = $('#ss-widget-container').attr('data-profileName');
	var profileLevel = $('#ss-widget-container').attr('data-profileLevel');
	var companyProfileName = $('#ss-widget-container').attr('data-companyProfileName');

	if (reviewSources.length == 0) {
		var reviewDiv = '<div id="ss-widget-review-no-source-selected" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev" style="text-align: center;">No review Source Selected</div>';
		$('#ss-widget-review-div').html(reviewDiv);
		return;
	} else {
		$('#ss-widget-review-no-source-selected').remove();
	}

	var payload = {
		"startScore" : -1,
		"limitScore" : -1,
		"startIndex" : startIndex,
		"numOfRows" : batchSize,
		"profileLevel" : profileLevel,
		"companyProfileName" : companyProfileName,
		"profileName" : profileName,
		"fetchAbusive" : false,
		"startDate" : "",
		"endDate" : "",
		"sortCriteria" : reviewSortOrder,
		"surveySources" : reviewSources
	};

	callAjaxGetWithPayloadJsonpData($, ssHost +'/rest/widget/getreviews', function(data) {
		paintWidgetReviewsForLoadMore($, data, resourcesHost, ssHost);
		var widgetDetails = $('#ss-widget-review-div').data('widgetDetails');
		paintWidgetReviewStyles($, widgetDetails);
	}, function() {
	}, payload, true);
}


function updateWidgetReviews($, resourcesHost, ssHost) {
	$('#ss-widget-review-div').attr('data-nextBatchIndex',0);
	var startIndex = 0;
	var batchSize = 20;
	var reviewSortOrder = $('#ss-widget-order-data').attr('data-order');
	var reviewSources = getReviewSources($);
	var profileName = $('#ss-widget-container').attr('data-profileName');
	var profileLevel = $('#ss-widget-container').attr('data-profileLevel');
	var companyProfileName = $('#ss-widget-container').attr('data-companyProfileName');

	$('#ss-widget-review-div').html('');

	if (reviewSources.length == 0) {
		var reviewDiv = '<div id="ss-widget-review-no-source-selected" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ss-widget-rev" style="text-align: center;">No review Source Selected</div>';
		$('#ss-widget-review-div').html(reviewDiv);
		return;
	} else {
		$('#ss-widget-review-no-source-selected').remove();
	}

	var payload = {
		"startScore" : -1,
		"limitScore" : -1,
		"startIndex" : startIndex,
		"numOfRows" : batchSize,
		"profileLevel" : profileLevel,
		"companyProfileName" : companyProfileName,
		"profileName" : profileName,
		"fetchAbusive" : false,
		"startDate" : "",
		"endDate" : "",
		"sortCriteria" : reviewSortOrder,
		"surveySources" : reviewSources
	};

	callAjaxGetWithPayloadJsonpData($, ssHost +'/rest/widget/getreviews', function(data) {
		paintWidgetReviews($, data, resourcesHost, ssHost);
		var widgetDetails = $('#ss-widget-review-div').data('widgetDetails');
		paintWidgetReviewStyles($, widgetDetails);

		var initialNumberOfReviews = parseInt($('#ss-widget-review-div').attr('data-initalRev'));

	}, function() {
	}, payload, true);
}

function getReviewSources($) {
	var reviewSources = "";

	if ($('#widget-opt-all').prop('checked')) {
		reviewSources = 'SocialSurvey,SocialSurvey Verified,Zillow';
	} else {
		if ($('#widget-opt-ss').prop('checked')) {
			reviewSources += ',SocialSurvey';
		}

		if ($('#widget-opt-ssv').prop('checked')) {
			reviewSources += ',SocialSurvey Verified';
		}

		if ($('#widget-opt-zil').prop('checked')) {
			reviewSources += ',Zillow';
		}
	}
	
	if( reviewSources.charAt(0) == ',' ) {
		reviewSources = reviewSources.substring(1, reviewSources.length );
	}

	return reviewSources;
}

function paintWidgetReviewsForLoadMore($, reviews, resourcesHost, ssHost) {

	for (var i = 0; i < reviews.length; i++) {
		$('#ss-widget-review-div').append(widgetReviewTemplate);
		var reviewSource = reviews[i].source;
		var profileImageUrl = reviews[i].agentProfileImage;
		var profName = reviews[i].agentName;
		var title = reviews[i].agentTitle;
		var rating = reviews[i].score;
		var customerCity = reviews[i].city;
		var customerState = reviews[i].state;
		var review = reviews[i].review;
		
		var customerName = '';
		if(reviews[i].customerFirstName != null && reviews[i].customerFirstName != undefined && reviews[i].customerFirstName != 'null' && reviews[i].customerFirstName != ' '){
			customerName = reviews[i].customerFirstName + ' '; 
		}
		
		if(reviews[i].customerLastName != null && reviews[i].customerLastName != undefined && reviews[i].customerLastName != 'null' && reviews[i].customerLastName != ' '){
			customerName += reviews[i].customerLastName; 
		}
		
		var reviewDateTimeStamp;
		if(reviews[i].surveyTransactionDate != null && reviews[i].surveyTransactionDate != undefined && reviews[i].surveyTransactionDate != '' && parseInt(reviews[i].surveyTransactionDate) != 0){
			reviewDateTimeStamp = parseInt(reviews[i].surveyTransactionDate);
		}else{
			reviewDateTimeStamp = parseInt(reviews[i].createdOn);
		}

		var reviewDate = new Date(reviewDateTimeStamp);
		var monthName = new Array("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December");
		var reviewDateStr = monthName[reviewDate.getMonth()] + ' ' + (reviewDate.getDate() % 10 != reviewDate.getDate() ? reviewDate.getDate() : ('0' + reviewDate.getDate())) + ', ' + reviewDate.getFullYear() + ' at ' + (reviewDate.getHours() % 10 != reviewDate.getHours() ? reviewDate.getHours() : ('0' + reviewDate.getHours())) + ':' + (reviewDate.getMinutes() % 10 != reviewDate.getMinutes() ? reviewDate.getMinutes() : ('0' + reviewDate.getMinutes())) + ':' + (reviewDate.getSeconds() % 10 != reviewDate.getSeconds() ? reviewDate.getSeconds() : ('0' + reviewDate.getSeconds()));
		$('#ss-widget-review-container').find('.ss-widget-rev-date').html(reviewDateStr);
		drawWidgetVerifiedBadge($, reviewSource);

		if(profileImageUrl == null|| profileImageUrl == undefined || profileImageUrl == ''){
			profileImageUrl = resourcesHost +'/widget/images/person.png';
			$('#ss-widget-review-container').find('.ss-widget-prof-pic').addClass('ss-widget-default-dp');
		}
		$('#ss-widget-review-container').find('.ss-widget-prof-pic').attr('src', profileImageUrl);
		
		$('#ss-widget-review-container').find('.ss-widget-rev-prof-name').html(profName);
		$('#ss-widget-review-container').find('.ss-widget-rev-prof-title').html(title);
		drawWidgetRatingStars($, $('#ss-widget-review-container').find('.ss-widget-rev-stars'), rating)
		$('#ss-widget-review-container').find('.ss-widget-rev-score').html(rating);
		$('#ss-widget-review-container').find('.ss-widget-rev-cust-name').html(customerName);
		$('#ss-widget-review-container').find('.ss-widget-rev-cust-addr').html(' -' + customerCity + ', ' + customerState);
		$('#ss-widget-review-container').find('.ss-widget-review-text').html(review);

		if (reviewSource == 'Zillow') {
			$('#ss-widget-review-container').find('.ss-widget-rev-stars').addClass('ss-widget-zil-rev-star');
		}

		$('#ss-widget-review-container').removeClass('hide');
		if ($('#ss-widget-review-container').find('.ss-widget-review-text').height() <= $('#ss-widget-review-container').find('.ss-widget-rev-text').height() + 2) {
			$('#ss-widget-review-container').find('.ss-widget-read-more').hide();
		}
		$('#ss-widget-review-container').addClass('hide');

		var nextBatchIndex = parseInt($('#ss-widget-review-div').attr('data-nextBatchIndex'));
		$('#ss-widget-review-container').attr('data-index', (nextBatchIndex + i + 1));
		$('#ss-widget-review-container').attr('id', 'ss-widget-review-container-' + (nextBatchIndex + i));

	}
	
	$('#ss-widget-review-div').attr('data-nextBatchIndex', parseInt($('#ss-widget-review-div').attr('data-nextBatchIndex')) + reviews.length);
	
	var loadMoreFlag = false;
	$('#ss-widget-reviews').find('.ss-widget-rev').each(function(){
		if($(this).hasClass('hide')){
			loadMoreFlag =  true;
			return false;
		}
	});
	
	if(loadMoreFlag){
		$('#ss-widget-load-more-btn').show();
	}else{
		$('#ss-widget-load-more-btn').hide();
	}
}

function callAjaxGetWithPayloadJsonpData($, url, callBackFunction, completeCallBackFn, payload, isAsync) {

	if (typeof isAsync === "undefined") {
		isAsync = true;
	}

	return $.ajax({
		url : url,
		headers : {
			Accept : "text/plain; charset=utf-8"
		},
		type : "GET",
		data : payload,
		dataType : "jsonp",
		async : isAsync,
		cache : false,
		success : callBackFunction,
		complete : completeCallBackFn,
		error : function(e) {
			if (e.status == 0) {
				return;
			}
		}
	});
}

function showWidgetDashOverlay($, dashid) {
	$(dashid).show();
}

function hideWidgetDashOverlay($, dashid) {
	$(dashid).hide();
}


function setupTags($, widgetDetails){
	var title = widgetDetails.widgetConfiguration.seoTitle;
	var keywords = widgetDetails.widgetConfiguration.seoKeywords;
	var description = widgetDetails.widgetConfiguration.seoDescription;
	
	var originalTitle = document.title;
	var originalKeywords = undefined;
	var originalDescription = undefined;
	
	if( $('meta[name="keywords"]') != null || $('meta[name="keywords"]') != undefined ){
		originalKeywords = $('meta').attr("name","keywords").attr("content");
	}
	
	if( $('meta[name="description"]') != null || $('meta[name="description"]') != undefined ){
		originalDescription = $('meta').attr("name","description").attr("content");
	}
	
	// create head if neccessary
	if( $('head').length <= 0 ){
		$('<head>').prependTo(document.body);
	}
	
	if( title != undefined && title != null && title != '' ){
		document.title = tagAppend(originalTitle, title);
	}
	
	if( keywords != undefined && keywords != null && keywords != '' ){
		if( document.querySelector('meta[name=keywords]') != null ){
			$('<meta>').attr("name","keywords").appendTo('head')
		}
		$('meta').attr("name","keywords").attr("content", tagAppend(originalKeywords, keywords));	
	}
	
	if( $('meta[name="description"]') != null && description != undefined && description != null && description != '' ){
		if( document.querySelector('meta[name=description]') != null  ){
			$('<meta>').attr("name","description").appendTo('head')
		}
		$('meta').attr("name","description").attr("content", tagAppend(originalDescription, description));	
	}
	
}

function tagAppend( str1, str2 ){
	
	if( str1 == undefined || str1 == null  ){
		str1 = '';
	}
	
	if( str2 == undefined || str2 == null  ){
		str2 = '';
	}
	
	if( str1.indexOf(str2) <= -1 ){
		return (str1 + ' ' + str2).trim();
	} else {
		return str1;
	}	
}
